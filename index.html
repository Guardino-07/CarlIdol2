<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Turn-by-Turn Navigation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    #map { height: 100vh; width: 100vw; }
    #top-controls, #instructions {
      position: absolute; z-index: 1001; left: 10px;
      background: white; border-radius: 8px; box-shadow: 0 0 10px #00000030;
      padding: 10px; font-size: 1rem;
    }
    #top-controls { top: 10px; max-width: 400px; display: flex; flex-direction: column; gap: 8px; }
    #instructions { bottom: 10px; right: 10px; max-height: 40vh; overflow-y: auto; word-break: break-word; }
    select, button {
      font-size: 1rem; padding: 10px; border-radius: 6px; border: 1px solid #aaa;
    }
    button {
      background: #007bff; color: white; font-weight: bold; cursor: pointer;
      box-shadow: 0 2px 8px #00000020; border: none;
    }
    button:disabled { background: #b0b0b0; cursor: not-allowed; }
    @media (max-width: 600px) {
      #instructions { font-size: 1em; }
      #top-controls { max-width: 95vw; }
    }
  </style>
</head>
<body>
  <div id="top-controls">
    <select id="building-select">
      <option disabled selected value="">Select a Destination</option>
      <option value="9.649295884532481,123.86859277164733">Bates Building</option>
      <option value="9.648274323006579,123.867375894612">Elementary Building</option>
      <option value="9.649258920201365,123.86913815071111">Senior High School Building</option>
      <option value="9.6501393425521,123.86784628406689">College of Art Sciences Building</option>
      <option value="9.648836069141659,123.8671386907348">Junior High School Building</option>
    </select>
    <button id="start-nav-btn" disabled>START NAVIGATING</button>
  </div>
  <div id="map"></div>
  <div id="instructions">Select a destination above to get a blue route line from your current location.</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([9.649, 123.868], 17);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
      maxZoom: 19,
    }).addTo(map);

    const instructionsEl = document.getElementById('instructions');
    const startBtn = document.getElementById('start-nav-btn');
    const selectEl = document.getElementById('building-select');

    let destLatLng = null, destMarker = null, userMarker = null, watchId = null;
    let routingControl = null, currentDestinationLabel = "", lastUpdateTime = 0;

    function showInstructions(text) {
      instructionsEl.innerHTML = text;
    }

    function updateDestinationMarker(latlng, label) {
      if (destMarker) map.removeLayer(destMarker);
      destMarker = L.marker(latlng).addTo(map).bindPopup(label).openPopup();
    }

    function updateUserMarker(latlng) {
      if (userMarker) userMarker.setLatLng(latlng);
      else userMarker = L.marker(latlng).addTo(map).bindPopup("You are here").openPopup();
    }

    function fitMap(userLatLng, destLatLng) {
      const bounds = L.latLngBounds([userLatLng, destLatLng]);
      map.fitBounds(bounds, { padding: [70, 70] });
    }

    function loadRoutingMachine(callback) {
      if (window.L.Routing) return callback();
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js';
      script.onload = callback;
      document.head.appendChild(script);
    }

    function createRoute(startLatLng, endLatLng) {
      if (routingControl) map.removeControl(routingControl);
      routingControl = L.Routing.control({
        waypoints: [L.latLng(startLatLng), L.latLng(endLatLng)],
        router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
        lineOptions: { styles: [{ color: 'blue', opacity: 0.8, weight: 6 }] },
        // Set 'show' to false to hide the instructions panel
        show: false,
        addWaypoints: false,
        draggableWaypoints: false,
        fitSelectedRoutes: true,
        // Also ensure no container is specified for instructions
        routeWhileDragging: false,
        createMarker: (i, wp, nWps) => i === nWps - 1 ? L.marker(wp.latLng).bindPopup(currentDestinationLabel) : null
      }).addTo(map);

      routingControl.on('routesfound', e => {
        const route = e.routes[0];
        const duration = Math.round(route.summary.duration / 60);
        const distance = (route.summary.distance / 1000).toFixed(2);
        showInstructions(`Route loaded: ${distance} km, approx. ${duration} min.`);
      });

      routingControl.on('routingerror', () => {
        showInstructions("Routing error. Please check your location and network.");
      });
    }

    selectEl.addEventListener('change', () => {
      if (!selectEl.value) return;
      destLatLng = selectEl.value.split(',').map(Number);
      currentDestinationLabel = selectEl.options[selectEl.selectedIndex].text;
      updateDestinationMarker(destLatLng, currentDestinationLabel);
      startBtn.disabled = false;
      showInstructions("Press <b>START NAVIGATING</b> to begin.");
      map.setView(destLatLng, 17);
    });

    startBtn.addEventListener('click', () => {
      if (!destLatLng) return;
      startBtn.blur();
      if (routingControl) map.removeControl(routingControl);
      if (userMarker) map.removeLayer(userMarker);
      if (watchId !== null) navigator.geolocation.clearWatch(watchId);

      if (!navigator.geolocation) return showInstructions("Geolocation not supported.");

      showInstructions("Getting your current location...");
      watchId = navigator.geolocation.watchPosition(pos => {
        const now = Date.now();
        if (now - lastUpdateTime < 5000) return;
        lastUpdateTime = now;

        const userLatLng = [pos.coords.latitude, pos.coords.longitude];
        updateUserMarker(userLatLng);
        fitMap(userLatLng, destLatLng);

        loadRoutingMachine(() => createRoute(userLatLng, destLatLng));
      }, () => {
        showInstructions("Location access denied or unavailable.");
      }, { enableHighAccuracy: true, maximumAge: 0, timeout: 12000 });
    });
  </script>
</body>
</html>
